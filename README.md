# Bookmarks
## Часть 1
Django просматривает шаблоны в порядке появления в INSTALLED_APPS
django.contib.admin - стандартные шаблоны аутентификации, будут переопределены нашим приложением

Поставляемая в комплекте система аутентификации (django.contrib.auth):
* вход/выход в систему
* Смена пароля
* Сброс пароля

Middleware - классы с методами, исполняются глобально во время запроса/ответа:
* AuthenticationMiddleware - ассоциация пользователей с сеансами
* SessionMiddleware - оперерирует сеансами

Модели:
* User - username, password, email, first_name, last_name и is_active
* Group - отнесение пользователя к категориям
* Permission - флаги для пользователей или групп для выполнения ими действий

Представления, формы

### Superuser
admin
admin@admin.com
secret_password1

### test user
test
testuser1

### Встроенные в Django представления аутентификации
* LoginView - Вход, регистрация входа пользователя
* LogoutView - Регистрация выхода пользователя
Смена пароля
* PasswordChangeView - Форма для смены пароля пользователя
* PasswordChangeDoneView - Страница об успехе смена пароля
Сброс пароля
* PasswordResetView - Генерирует одноразовую ссылку-токен и отсылает на почту
* PasswordResetDoneView - Сообщение об отправленной ссылке на почту
* PasswordResetConfirmView - Установка нового пароля
* PasswordResetCompleteView - Страница об успехе сброса пароля

Скрытый параметр next в форме - куда направить пользователя после входа

Настроечные параметры:
* LOGIN_REDIRECT_URL - на какой адрес перенаправлять после успешного входа
* LOGIN_URL - перенаправление на вход
* LOGOUT_URL - перенаправление на выход

Текущий пользователь - request.user
Если пользователь не аутентифицирован, это поле будет AnonymousUser.
Самый лучший способ проверить - `request.user.is_authenticated`

Django предоставляет шаблонные адреса

### Регистрация
Поле username будет валидироваться на уникальность

метод `cleaned_<fieldname>()` можно переопределить для того, 
чтобы самостоятельно очищать значения или вызывать ошибку валидации

Переопределение метода clean() - полезно для валидации зависящих друг от друга полей
`UserCreationForm` - готовая форма от Django

test
test@test.com
testtest2

### Расширение модели пользователя
Простой способ расширение модели - создание модели Профиля один-к-одному
Встроенная взаимосвязь один-к-одному:
- Со связной моделью вместо менеджера
- С каждой стороны есть связь к одному объекту

Библиотека Pillow - стандартная для обработки изображений Python

* MEDIA_URL - базовый URL адрес для раздачи медиафайлов
* MEDIA_ROOT - локальный путь, где они будут хранится

`multitype/form-data` - обеспечение закачки файлов на сайт

Можно также унаследовать AbstractUser для создания своей модели User

### Использование фреймворка сообщений
`django.contrib.messages`
`django.contrib.messages.middleware.MessageMiddleware`

```python
from django.contrib import messages
messages.error(request, 'Something went wrong')
```

add_message()
* success()
* info()
* warning()
* error()
* debug()

Процессор контекста добавляет переменную messages в запрос
Процессор контекста - функция, принимает request и возвращает словарь, который добавляется в контекст запроса

### Бэкенд аутентификации
В Django можно использовать различные бэкенды аунтетификации
`AUTHENTICATION_BACKENDS = ['django.contrib.auth.backends.ModelBackend']`
Что означает использовать базу данных с моделью User

При использовании authenticate() Django по очереди пытается аутентифицировать пользователей
на каждом из бэкендов, пока один из них не выдаст успешно

Бэкенд аутентификации - класс с методами:
* authenticate()
  * Принимает request(None если не передан), учетные данные
  * возвращает user или None
* get_user()
  * Принимает id
  * возвращает user или None

test3
email@example.com
testuser3

.exists() - помогает проверить, пустой ли QuerySet или нет

## Часть 2
* PythonSocialAuth
  * Google
  * Facebook
  * Twitter
* HTTPS
* Автоматическое создание профилей

### Социальная аутентификация
Прохождение аутентификации с помощью существующей учетной записи поставщика услуг (SSO - single sign-on)
OAuth 2.0 - Open Authorization
- Python Social Auth - модуль для реализации
1. Требуют выделенного хоста. Для этого подменим хост изменив файл `C:\Windows\System32\Drivers\etc\hosts`
   ALLOWED_HOSTS - Django разрешает раздавать приложение только тем хостам, которые включены в список
   Когда DEBUG=True, `ALLOWED_HOSTS = ['localhost', '127.0.0.1']`
2. HTTPS
   - RunServerPlus из пакета Django extension
   - Werkzeug - слой отладчика
   - pyOpenSSL - использование функциональности SSL/TLS
   `python manage.py runserver_plus --cert-file cert.crt`
   
    Сертификат самоподписанный - браузеры будут ругатся, но позволят войти

### Создание профиля после аутентификации
Конвейер соц аутентификации

## Часть 3: Наполнение содержимым
1) Создать модель данных изображения
2) форма и представление для редактирования инфы
3) Букмарклет, который можно испольнять на любом сайте

### Взаимосвязь многие-ко-многим
.add(object)
.remove(object)
.clear()
### easy thumbnail
создание миниатюр
300x0 - фиксированная ширина 300, гибкая высота
q - quility (default - 85)

## Часть 3: Наполнение содержимым
- промежуточная модель - отношении Many-to-Many
  - Сохранение информации о создании
  - Не нужно изменять модели


contenttypes - отслеживание всех установленных моделей и интерфейс для работы с ними
* app_label - имя приложения, которому модель принадлежит (Meta.app_label)
* model - имя модельного класса
* name - удобочитаемое имя модели (Meta.verbose_name)

Оптимизация наборов запросов со связанными объектами
* select_related() - извлечение один-ко-многим (выполняет JOIN)
* prefetch_related() - многие-ко-многим, многие-к-одному, Generic, один-ко-многим 
(отдельный поиск для каждой взаимосвязи и соединение в Python)

### Денормализация
Оптимизация базы данных
- Рассмотреть вариант кэширования, индексов бд, оптимизацию запросов
- Денормализовывать - создать новое поле с уже посчитанными значениями (общее кол-во лайков)

Метод ready() в конфигурационном классе
- Вызывается когда реестр приложений полностью заполнен
- Используется для инициализаций приложений (в том числе для сигналов)

### Debug toolbar
debugsqlshell - аналог обычной оболочки, только все ORM запросы здесь будут отображаться как SQL команды

### Redis
Remote Dictionary Server
- Ключ-значение
- Очень быстрое
- Хранит все в памяти, но можно сохранять на диск или набор команд в журнал
- Быстро меняющиеся данные, энергозависимое хранилище, быстрое кэширование

```shell
docker pull redis
```

```shell
docker run -it --rm --name redis -p 6379:6379 redis
```

В redis базы имеют имена-номера. По умолчанию 0, максимально - 16 (изменить в redis.conf)
Ключ формата `object-type:id:field`

Сценарии, когда Redis полезен:
* Подсчет количеств 
* Хранение последних элементов - lpush, rpush(), lpop, rpop(), ltrim() - поддержка заданной длины
* Очереди - блокирование команд
* Кэширование - expire(), expireat()
* Публикация, подписка, сообщения в канал
* Рейтинг и списки лидеров
* Отслеживание в реальном времени